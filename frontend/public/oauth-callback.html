<!-- public/oauth-callback.html -->
<!DOCTYPE html>
<html>
  <head><meta charset="utf-8" /><title>OAuth Callback</title></head>
  <body>
    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const error = params.get("error");
        const verifier = sessionStorage.getItem("pkce_verifier");
        if (!code && error) {
          window.opener.postMessage({ type: "GOOGLE_OAUTH", error }, window.location.origin);
          return window.close();
        }
        const body = new URLSearchParams({
          client_id: sessionStorage.getItem("pkce_client_id"),
          grant_type: "authorization_code",
          code,
          redirect_uri: window.location.origin + "/oauth-callback.html",
          code_verifier: verifier,
        });
        const resp = await fetch("https://oauth2.googleapis.com/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString(),
        });
        const data = await resp.json();
        window.opener.postMessage({ type: "GOOGLE_OAUTH", token: data.access_token, error: data.error }, window.location.origin);
        window.close();
      })();
    </script>
  </body>
</html>
